{% extends 'base.html' %}
{% block content %}
<style>
  .login-tabs { display: flex; gap: 6px; margin-bottom: 18px; }
  .login-tab {
    flex: 1; padding: 10px; text-align: center; border-radius: 8px;
    cursor: pointer; font-size: 14px; font-weight: 600;
    background: var(--card-bg, #1E2D3D); color: var(--muted, #8B98A5);
    border: 1px solid var(--border, #38444D); transition: all 0.2s;
  }
  .login-tab.active { background: var(--primary, #1D9BF0); color: #fff; border-color: var(--primary, #1D9BF0); }
  .login-panel { display: none; }
  .login-panel.active { display: block; }
  .file-zone {
    border: 2px dashed var(--border, #38444D); border-radius: 12px; padding: 28px;
    text-align: center; cursor: pointer; transition: border-color 0.2s; margin-bottom: 14px;
  }
  .file-zone:hover, .file-zone.dragover { border-color: var(--primary, #1D9BF0); }
  .file-zone input[type="file"] { display: none; }
  .file-zone .fz-icon { font-size: 30px; margin-bottom: 6px; }
  .file-zone .fz-text { color: var(--muted, #8B98A5); font-size: 13px; }
  .file-zone .fz-name { color: var(--primary, #1D9BF0); font-size: 14px; font-weight: 600; margin-top: 6px; }
  .bulk-progress { height: 6px; background: var(--border, #273340); border-radius: 3px; margin: 12px 0; overflow: hidden; display: none; }
  .bulk-progress .fill { height: 100%; background: var(--primary, #1D9BF0); border-radius: 3px; transition: width 0.3s; width: 0%; }
  .bulk-status { margin-top: 12px; padding: 12px; border-radius: 8px; font-size: 14px; display: none; text-align: center; line-height: 1.7; }
  .bulk-status.loading { display: block; background: rgba(29,155,240,0.1); color: var(--primary, #1D9BF0); }
  .bulk-status.success { display: block; background: rgba(0,186,124,0.1); color: #00BA7C; }
  .bulk-status.error { display: block; background: rgba(244,33,46,0.1); color: #F4212E; }
  .bulk-results { margin-top: 16px; }
  .bulk-results .acc-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 12px; border-radius: 8px; margin-bottom: 4px; font-size: 13px;
    background: var(--card-bg, #1E2D3D);
  }
  .acc-row .user { font-weight: 600; color: var(--primary, #1D9BF0); }
  .acc-row .badge { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
  .acc-row .badge.ok { background: rgba(0,186,124,0.15); color: #00BA7C; }
  .acc-row .badge.fail { background: rgba(244,33,46,0.15); color: #F4212E; }
  .spinner-inline {
    display: inline-block; width: 14px; height: 14px;
    border: 2px solid var(--primary, #1D9BF0); border-top-color: transparent;
    border-radius: 50%; animation: spin-bulk 0.8s linear infinite; vertical-align: middle; margin-left: 4px;
  }
  @keyframes spin-bulk { to { transform: rotate(360deg); } }
</style>

  <div class="grid">
    <div class="card" style="grid-column: span 7">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ X ÙˆØ­ÙØ¸ Ø§Ù„ÙƒÙˆÙƒÙŠØ²</h3>

      <div class="login-tabs">
        <div class="login-tab active" onclick="switchLoginTab('single', this)">Ø­Ø³Ø§Ø¨ ÙˆØ§Ø­Ø¯</div>
        <div class="login-tab" onclick="switchLoginTab('bulk', this)">Ø¹Ø¯Ø© Ø­Ø³Ø§Ø¨Ø§Øª (CSV)</div>
      </div>

      <!-- Ø­Ø³Ø§Ø¨ ÙˆØ§Ø­Ø¯ -->
      <div class="login-panel active" id="panel-single">
        <form method="POST" action="{{ url_for('login_page') }}" class="form">
          <div class="field half">
            <label>Label (Ø§Ø³Ù… Ø§Ù„Ø­ÙØ¸)</label>
            <input class="input" name="label" placeholder="acc1" required />
          </div>
          <div class="field half">
            <label>Headless</label>
            <select name="headless">
              <option value="0">No</option>
              <option value="1">Yes</option>
            </select>
          </div>
          <div class="field">
            <label>Username / Email</label>
            <input class="input" name="username" required />
          </div>
          <div class="field">
            <label>Password</label>
            <input class="input" type="password" name="password" required />
          </div>
          <div class="field">
            <button class="btn primary" type="submit">Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          </div>
        </form>
      </div>

      <!-- Ø¹Ø¯Ø© Ø­Ø³Ø§Ø¨Ø§Øª -->
      <div class="login-panel" id="panel-bulk">
        <div class="file-zone" id="fileZone" onclick="document.getElementById('csvFile').click()">
          <input type="file" id="csvFile" accept=".csv,.txt">
          <div class="fz-icon">ğŸ“„</div>
          <div class="fz-text">Ø§Ø¶ØºØ· Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù…Ù„Ù CSV Ù‡Ù†Ø§</div>
          <div class="fz-name" id="fileName"></div>
        </div>
        <div style="color:var(--muted);font-size:12px;text-align:center;margin-bottom:14px">
          ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù: <code>username,password</code> Ø£Ùˆ <code>username,password,label</code> (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø­Ø³Ø§Ø¨)
        </div>
        <button class="btn primary" id="bulkBtn" onclick="startBulkLogin()" disabled style="width:100%">Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <div class="bulk-progress" id="bulkProgress"><div class="fill" id="bulkFill"></div></div>
        <div class="bulk-status" id="bulkStatus"></div>
        <div class="bulk-results" id="bulkResults"></div>
      </div>
    </div>

    <div class="card" style="grid-column: span 5">
      <h3>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
      <ul style="margin:0;padding-right:18px;line-height:1.9;color:var(--muted);font-size:13px">
        <li>Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒÙˆÙƒÙŠØ² ÙÙŠ <code>cookies/&lt;label&gt;.json</code></li>
        <li>ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙØ³ Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ù„Ù„Ù†Ø´Ø± Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</li>
        <li>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØªÙ… Ø¹Ø¨Ø± API Ù…Ø¨Ø§Ø´Ø± â€” Ø¨Ø¯ÙˆÙ† Ù…ØªØµÙØ­</li>
        <li>Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¯Ø© Ø­Ø³Ø§Ø¨Ø§Øª: Ø§Ø±ÙØ¹ Ù…Ù„Ù CSV Ø¨ØµÙŠØºØ©:<br><code>username,password</code></li>
      </ul>
    </div>
  </div>

<script>
function switchLoginTab(tab, el) {
  document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.login-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-' + tab).classList.add('active');
}

// CSV Upload
let csvAccountCount = 0;
const csvFile = document.getElementById('csvFile');
const fileZone = document.getElementById('fileZone');

csvFile.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    const lines = ev.target.result.trim().split('\n');
    csvAccountCount = 0;
    lines.forEach(function(line) {
      line = line.trim();
      if (!line || line.toLowerCase().startsWith('username')) return;
      const parts = line.split(',');
      if (parts.length >= 2 && parts[0].trim() && parts[1].trim()) csvAccountCount++;
    });
    document.getElementById('fileName').textContent = file.name + ' (' + csvAccountCount + ' Ø­Ø³Ø§Ø¨)';
    document.getElementById('bulkBtn').disabled = (csvAccountCount === 0);
  };
  reader.readAsText(file);
});

fileZone.addEventListener('dragover', function(e) { e.preventDefault(); fileZone.classList.add('dragover'); });
fileZone.addEventListener('dragleave', function() { fileZone.classList.remove('dragover'); });
fileZone.addEventListener('drop', function(e) {
  e.preventDefault(); fileZone.classList.remove('dragover');
  csvFile.files = e.dataTransfer.files;
  csvFile.dispatchEvent(new Event('change'));
});

// Bulk Login
function startBulkLogin() {
  if (csvAccountCount === 0) return;
  var btn = document.getElementById('bulkBtn');
  var status = document.getElementById('bulkStatus');
  var bar = document.getElementById('bulkProgress');
  var fill = document.getElementById('bulkFill');
  var results = document.getElementById('bulkResults');

  btn.disabled = true;
  bar.style.display = 'block';
  fill.style.width = '0%';
  status.className = 'bulk-status loading';
  status.innerHTML = '<span class="spinner-inline"></span> Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ ' + csvAccountCount + ' Ø­Ø³Ø§Ø¨...';
  results.innerHTML = '';

  var formData = new FormData();
  formData.append('csv_file', csvFile.files[0]);

  fetch('{{ url_for("login_bulk_page") }}', { method: 'POST', body: formData })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success && data.task_id) {
        pollBulkTask(data.task_id);
      } else {
        status.className = 'bulk-status error';
        status.innerHTML = 'âœ— ' + (data.error || 'ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©');
        btn.disabled = false;
      }
    })
    .catch(function(err) {
      status.className = 'bulk-status error';
      status.innerHTML = 'âœ— Ø®Ø·Ø£: ' + err.message;
      btn.disabled = false;
    });
}

function pollBulkTask(taskId) {
  var status = document.getElementById('bulkStatus');
  var fill = document.getElementById('bulkFill');
  var btn = document.getElementById('bulkBtn');
  var resultsEl = document.getElementById('bulkResults');

  var interval = setInterval(function() {
    fetch('/x-login-bulk-status/' + taskId)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var pct = data.total > 0 ? Math.round((data.done / data.total) * 100) : 0;
        fill.style.width = pct + '%';
        status.className = 'bulk-status loading';
        status.innerHTML = '<span class="spinner-inline"></span> ' + data.done + '/' + data.total +
          ' (' + data.success + ' Ù†Ø¬Ø­ØŒ ' + data.failed + ' ÙØ´Ù„)';

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        var html = '';
        if (data.results && data.results.length > 0) {
          data.results.forEach(function(r) {
            html += '<div class="acc-row"><span class="user">@' + r.username + '</span>';
            if (r.success) {
              html += '<span class="badge ok">âœ“ Ù†Ø¬Ø­</span>';
            } else {
              html += '<span class="badge fail">âœ— ÙØ´Ù„</span>';
            }
            html += '</div>';
          });
        }
        resultsEl.innerHTML = html;

        if (data.finished) {
          clearInterval(interval);
          if (data.failed === 0) {
            status.className = 'bulk-status success';
            status.innerHTML = 'âœ“ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ' + data.success + ' Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!';
          } else {
            status.className = (data.success > 0) ? 'bulk-status success' : 'bulk-status error';
            status.innerHTML = 'Ù†Ø¬Ø­: ' + data.success + ' | ÙØ´Ù„: ' + data.failed;
          }
          btn.disabled = false;
        }
      })
      .catch(function() {});
  }, 2000);
}
</script>
{% endblock %}
